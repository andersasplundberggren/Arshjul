<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Årshjul</title>
  <style>
    /* ====== Teman via CSS-variabler ====== */
    :root{
      --bg:#0b1220; --fg:#e6eefc; --muted:#9fb0d3; --card:#101a33; --border:#1e2b4f;
      --accent:#72a3ff; --accent2:#ffcf70; --good:#5bd6a2; --bad:#ff7a7a;
    }
    /* Ljust tema */
    :root.light{
      --bg:#ffffff; --fg:#0b1220; --muted:#52607a; --card:#ffffff; --border:#e5e7eb;
      --accent:#2b59ff; --accent2:#b45309; --good:#059669; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg); transition:background .2s ease,color .2s ease}
    header{display:flex; gap:12px; align-items:center; padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,rgba(127,127,127,0.06),transparent)}
    h1{font-size:clamp(20px,2.6vw,28px); margin:0; letter-spacing:.3px}
    .wrap{display:grid; grid-template-columns:360px 1fr; gap:18px; padding:18px}
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; transition:background .2s ease,border-color .2s ease}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input, select, button, textarea{background:color-mix(in hsl, var(--card) 70%, black 10%); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    :root.light input, :root.light select, :root.light button, :root.light textarea{ background:color-mix(in hsl, var(--card) 85%, white 10%); }
    button{cursor:pointer}
    .pill{display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:color-mix(in hsl, var(--card) 80%, black 5%)}

    /* Year wheel */
    .stage{display:grid; place-items:center; min-height:520px;}
    svg{max-width:100%; height:auto}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    /* List */
    .list{display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto;}
    .item{background:color-mix(in hsl, var(--card) 80%, black 5%); border:1px solid var(--border); border-radius:12px; padding:10px}
    .item h3{margin:0 0 6px; font-size:15px}
    .item small{color:var(--muted)}

    .admin{display:none;}
    .admin.show{display:block}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .mt{margin-top:12px}
    .right{margin-left:auto}
    .hint{color:var(--muted); font-size:12px}
    .sp{height:8px}
    a{color:var(--accent)}
    .error{background:#2a0f14; border:1px solid #5a1b25; color:#ffd2d2; padding:10px; border-radius:10px; margin-top:10px; display:none}
  </style>
</head>
<body>
  <header>
    <h1>Årshjul</h1>
    <span class="pill">Datakälla: Google Sheet</span>
    <span class="pill">TZ: Europe/Stockholm</span>
    <div class="right"></div>
    <!-- Tema-switch -->
    <label class="pill" style="gap:8px; cursor:pointer">
      <input id="themeSwitch" type="checkbox" style="accent-color:var(--accent)" />
      <span id="themeLabel">Mörkt läge</span>
    </label>
    <button id="toggle-admin" style="margin-left:8px">Admin</button>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="row">
        <input id="search" placeholder="Sök titel/beskrivning…" />
        <select id="category">
          <option value="">Alla kategorier</option>
        </select>
        <select id="year"></select>
        <button id="refresh">Uppdatera</button>
      </div>
      <div class="stage" id="stage"></div>
      <div class="legend" id="legend"></div>
      <div class="error" id="err"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px">Händelser</h2>
      <div class="list" id="list"></div>
    </section>
  </div>

  <section class="card admin" id="admin">
    <h2 style="margin:0 0 8px">Adminpanel</h2>
    <div class="hint">Fyll i din API-nyckel (ADMIN_TOKEN). URL är redan satt till din Web App.</div>
    <div class="grid2 mt">
      <input id="apiUrl" />
      <input id="apiKey" placeholder="ADMIN_TOKEN" />
    </div>

    <h3 style="margin:14px 0 6px">Lägg till / uppdatera händelse</h3>
    <div class="grid3">
      <input id="evId" placeholder="id (tomt = nytt)" />
      <input id="title" placeholder="Titel" />
      <input id="categoryInput" placeholder="Kategori" />
    </div>
    <div class="grid3 mt">
      <input id="start" type="date" />
      <input id="end" type="date" />
      <input id="color" type="color" value="#72a3ff" />
    </div>
    <div class="grid2 mt">
      <input id="link" placeholder="Länk (valfritt)" />
      <input id="location" placeholder="Plats (valfritt)" />
    </div>
    <textarea id="desc" class="mt" rows="3" placeholder="Beskrivning"></textarea>
    <div class="row mt">
      <button id="save">Spara</button>
      <button id="del" style="background:#2a0f14; border-color:#5a1b25">Ta bort</button>
    </div>
  </section>

<script>
/* ====== KONFIG ====== */
const DEFAULT_API_BASE = 'https://script.google.com/macros/s/AKfycbySOXro_Qk9bqD98mUBbJ3h1voYuD-EJ1QD8ZLpsi3cw8feXCUx-shoMYI0umx6vEnW/exec';
const API_BASE = localStorage.getItem('apiUrl') || DEFAULT_API_BASE;

/* ====== Hjälpare ====== */
const TZ = 'Europe/Stockholm';
const uid = () => Math.random().toString(36).slice(2,10);
const el  = (sel) => document.querySelector(sel);
const ELLIPSE_RX = 180, ELLIPSE_RY = 180;
const MONTHS = ['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];

function showError(msg){ const box = el('#err'); box.textContent = msg; box.style.display = 'block'; }
function clearError(){ const box = el('#err'); box.textContent = ''; box.style.display = 'none'; }

/* ====== Tema-switch ====== */
function initTheme(){
  const saved = localStorage.getItem('theme2') || 'dark';
  const root = document.documentElement;
  const sw = el('#themeSwitch');
  const lbl = el('#themeLabel');
  const isLight = saved==='light';
  root.classList.toggle('light', isLight);
  sw.checked = isLight;
  lbl.textContent = isLight ? 'Ljust läge' : 'Mörkt läge';
  sw.onchange = ()=>{
    const on = sw.checked;
    root.classList.toggle('light', on);
    localStorage.setItem('theme2', on ? 'light' : 'dark');
    lbl.textContent = on ? 'Ljust läge' : 'Mörkt läge';
  };
}

/* ====== Datum → position/vinkel ====== */
function dayOfYear(date){
  const start = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.floor((date - start) / 86400000)+1;
}
function angleFor(date){
  const year = date.getUTCFullYear();
  const start = new Date(Date.UTC(year,0,1));
  const end   = new Date(Date.UTC(year+1,0,1));
  const totalDays = (end - start)/86400000;
  const day = dayOfYear(date);
  const frac = day/totalDays;
  return frac * Math.PI*2 - Math.PI/2; // 0 rad = kl 3, vi börjar uppe
}

/* ====== Datahämtning ====== */
async function fetchEvents(yearFilter){
  const base = localStorage.getItem('apiUrl') || API_BASE;
  const url = base + `?action=list` + (yearFilter?`&year=${yearFilter}`:'');
  const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
  if(!res.ok) throw new Error('API fel ('+res.status+')');
  return res.json();
}

/* ====== Rita årshjul (prick + periodbåge) ====== */
function drawWheel(events){
  const stage = el('#stage');
  stage.innerHTML = '';
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox','-240 -240 480 480');

  const R_DOT = 6, R_ARC = 190;

  // Bakgrundsring
  const ring = document.createElementNS(svgNS,'circle');
  ring.setAttribute('r','200'); ring.setAttribute('fill','none');
  ring.setAttribute('stroke','var(--border)'); ring.setAttribute('stroke-width','2');
  svg.appendChild(ring);

  // Månadstickar & etiketter
  for(let m=0;m<12;m++){
    const a = (m/12)*Math.PI*2 - Math.PI/2;
    const x1 = Math.cos(a)*180, y1=Math.sin(a)*180;
    const x2 = Math.cos(a)*200, y2=Math.sin(a)*200;
    const line = document.createElementNS(svgNS,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('stroke','var(--border)');
    svg.appendChild(line);

    const lx = Math.cos(a)*155, ly=Math.sin(a)*155;
    const lbl = document.createElementNS(svgNS,'text');
    lbl.setAttribute('x',lx); lbl.setAttribute('y',ly);
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('fill','var(--muted)');
    lbl.textContent = MONTHS[m];
    svg.appendChild(lbl);
  }

  function arcBetween(s,e,color){
    const a1 = angleFor(s);
    const a2 = angleFor(e);
    const delta = (a2 - a1 + Math.PI*2) % (Math.PI*2);
    const largeArc = delta > Math.PI ? 1 : 0;
    const sweep = 1;
    const x1 = Math.cos(a1)*R_ARC, y1 = Math.sin(a1)*R_ARC;
    const x2 = Math.cos(a2)*R_ARC, y2 = Math.sin(a2)*R_ARC;
    const path = document.createElementNS(svgNS,'path');
    const d = `M ${x1.toFixed(2)} ${y1.toFixed(2)} A ${R_ARC} ${R_ARC} 0 ${largeArc} ${sweep} ${x2.toFixed(2)} ${y2.toFixed(2)}`;
    path.setAttribute('d', d);
    path.setAttribute('fill','none');
    path.setAttribute('stroke', color);
    path.setAttribute('stroke-width','6');
    path.setAttribute('stroke-linecap','round');
    path.setAttribute('opacity','0.85');
    svg.appendChild(path);
  }

  function drawArc(startDate,endDate,color){
    const y = startDate.getUTCFullYear();
    const clampStart = new Date(Date.UTC(y,0,1));
    const clampEnd   = new Date(Date.UTC(y+1,0,1) - 1);

    if(!endDate || isNaN(endDate.getTime())){
      const a = angleFor(startDate);
      const dot = document.createElementNS(svgNS,'circle');
      dot.setAttribute('cx', Math.cos(a)*R_ARC);
      dot.setAttribute('cy', Math.sin(a)*R_ARC);
      dot.setAttribute('r', R_DOT);
      dot.setAttribute('fill', color);
      svg.appendChild(dot);
      return;
    }

    if(endDate < startDate){
      // wrap: rita del i detta år (start → 31/12)
      arcBetween(startDate, new Date(Date.UTC(y,11,31)), color);
      return;
    }

    const s = new Date(Math.max(startDate, clampStart));
    const e = new Date(Math.min(endDate, clampEnd));
    arcBetween(s,e,color);
  }

  // Rita events
  events.forEach(ev=>{
    const color = ev.color || 'var(--accent)';
    const sd = new Date(ev.start_date+'T12:00:00Z');
    const ed = ev.end_date ? new Date(ev.end_date+'T12:00:00Z') : null;
    drawArc(sd, ed, color);
  });

  stage.appendChild(svg);
}

/* ====== Listan + filter ====== */
function renderList(events){
  const q = el('#search').value.toLowerCase();
  const c = el('#category').value;
  const list = el('#list'); list.innerHTML='';

  const filtered = events.filter(ev=>{
    const hay = `${ev.title} ${ev.description||''} ${ev.category||''}`.toLowerCase();
    return (!q || hay.includes(q)) && (!c || ev.category===c);
  }).sort((a,b)=>a.start_date.localeCompare(b.start_date));

  filtered.forEach(ev=>{
    const div = document.createElement('div');
    div.className='item'; div.id='item-'+ev.id;
    div.innerHTML = `
      <h3><span style="display:inline-block;width:10px;height:10px;background:${ev.color||'var(--accent)'};border-radius:999px;margin-right:8px"></span>${ev.title}</h3>
      <small>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}${ev.location?` • ${ev.location}`:''}</small>
      <div class="sp"></div>
      <p style="margin:0 0 8px">${ev.description||''}</p>
      ${ev.link?`<a href="${ev.link}" target="_blank" rel="noreferrer">Öppna länk</a>`:''}
    `;
    list.appendChild(div);
  });

  // Fyll kategori-dropdown utifrån data
  const catSel = el('#category');
  const cur = catSel.value;
  const cats = [...new Set(events.map(e=>e.category).filter(Boolean))].sort();
  catSel.innerHTML = '<option value="">Alla kategorier</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if([...catSel.options].some(o=>o.value===cur)) catSel.value = cur;
}

/* ====== Init/Load ====== */
let ALL_EVENTS = [];

async function load(year){
  try{
    clearError();
    const data = await fetchEvents(year);
    ALL_EVENTS = Array.isArray(data) ? data : (data.events || []);
    drawWheel(ALL_EVENTS);
    renderList(ALL_EVENTS);
  }catch(err){ showError(err.message); }
}

function populateYears(){
  const yearSel = el('#year');
  const y=new Date().getFullYear();
  const years=[y-1,y,y+1,y+2];
  yearSel.innerHTML=years.map(v=>`<option ${v===y?'selected':''} value="${v}">${v}</option>`).join('');
}

/* ====== Admin POST (utan preflight) ====== */
async function adminPost(action,payload){
  const base=el('#apiUrl').value.trim();
  const key=el('#apiKey').value.trim();
  if(!base||!key){alert('Fyll i API-URL + nyckel');return;}
  localStorage.setItem('apiUrl',base);
  localStorage.setItem('apiKey',key);
  const body=new URLSearchParams({action,token:key,...payload});
  const res=await fetch(base,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body});
  const j=await res.json().catch(()=>({}));
  if(!res.ok || j.error){alert('Fel: '+(j.error || res.status));return;}
  await load(el('#year').value);
  alert('Klart!');
}

/* ====== Start ====== */
window.addEventListener('DOMContentLoaded',()=>{
  initTheme();
  populateYears();
  el('#apiUrl').value=API_BASE;
  el('#apiKey').value=localStorage.getItem('apiKey')||'';

  el('#refresh').onclick=()=>load(el('#year').value);
  el('#category').onchange=()=>renderList(ALL_EVENTS);
  el('#search').oninput=()=>renderList(ALL_EVENTS);
  el('#year').onchange=()=>load(el('#year').value);
  el('#toggle-admin').onclick=()=>el('#admin').classList.toggle('show');

  el('#save').onclick=()=>{
    if(!el('#title').value || !el('#start').value){ alert('Titel och startdatum krävs'); return; }
    adminPost('upsert',{
      id:(el('#evId').value||'').trim()||uid(),
      title:el('#title').value.trim(),
      description:el('#desc').value.trim(),
      start_date:el('#start').value,
      end_date:el('#end').value||'',
      category:el('#categoryInput').value.trim()||'',
      color:el('#color').value||'',
      link:el('#link').value.trim()||'',
      location:el('#location').value.trim()||''
    });
  };
  el('#del').onclick=()=>{
    const id=(el('#evId').value||'').trim();
    if(!id){alert('Ange id att radera');return;}
    if(confirm('Ta bort händelse?')) adminPost('delete',{id});
  };

  load(new Date().getFullYear());
});
</script>
</body>
</html>
