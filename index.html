<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Årshjul</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2372a3ff'/%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --muted:#9fb0d3; --card:#101a33; --border:#1e2b4f;
      --accent:#72a3ff; --accent2:#ffcf70; --good:#5bd6a2; --bad:#ff7a7a;
    }
    :root.light{
      --bg:#ffffff; --fg:#0b1220; --muted:#52607a; --card:#ffffff; --border:#e5e7eb;
      --accent:#2b59ff; --accent2:#b45309; --good:#059669; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg); transition:background .2s ease,color .2s ease}

    header{display:flex; gap:12px; align-items:center; padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,rgba(127,127,127,0.06),transparent)}
    h1{font-size:clamp(20px,2.6vw,28px); margin:0; letter-spacing:.3px}

    .wrap{
      display:grid;
      grid-template-columns: 1fr 1fr; /* 50/50 */
      gap:18px;
      padding:18px;
      height: calc(100vh - 78px);
      align-items: stretch;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; height:auto; } }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
      display:flex; flex-direction:column; min-height:0;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input, select, button{background:color-mix(in hsl, var(--card) 70%, black 10%); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    :root.light input,:root.light select,:root.light button{ background:color-mix(in hsl, var(--card) 85%, white 10%) }
    button{cursor:pointer}
    .pill{display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:color-mix(in hsl, var(--card) 80%, black 5%)}
    .right{margin-left:auto}

    .controls{margin-bottom:12px}
    .stage{display:grid; place-items:center; flex:1 1 auto; min-height:0;}
    svg{max-width:100%; height:auto}
    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .legend .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:12px}
    .legend .dot{width:10px; height:10px; border-radius:999px}

    .list{display:flex; flex-direction:column; gap:10px; overflow:auto; flex:1 1 auto; min-height:0;}
    .item{background:color-mix(in hsl, var(--card) 80%, black 5%); border:1px solid var(--border); border-radius:12px; padding:10px}
    .item h3{margin:0 0 6px; font-size:15px}
    .item small{color:var(--muted)}
    a{color:var(--accent)}
    .error{background:#2a0f14; border:1px solid #5a1b25; color:#ffd2d2; padding:10px; border-radius:10px; margin-top:10px; display:none}

    #tooltip{position:fixed; pointer-events:none; z-index:50; background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); display:none; max-width:260px}
  </style>
</head>
<body>
  <header>
    <h1>Årshjul</h1>
    <span class="pill">Datakälla: Google Sheet</span>
    <span class="pill">TZ: Europe/Stockholm</span>
    <div class="right"></div>
    <a href="admin.html" class="pill">Admin</a>
    <label class="pill" style="gap:6px; cursor:pointer">
      <input id="themeSwitch" type="checkbox" />
      <span id="themeLabel">Mörkt läge</span>
    </label>
  </header>

  <div id="tooltip" aria-hidden="true"></div>

  <div class="wrap">
    <!-- Vänster halva -->
    <section class="card">
      <div class="row controls">
        <input id="search" placeholder="Sök titel/beskrivning…" />
        <select id="category"><option value="">Alla kategorier</option></select>
        <select id="year"></select>
        <button id="refresh">Uppdatera</button>
      </div>
      <div class="stage" id="stage"></div>
      <div class="legend" id="legend"></div>
      <div class="error" id="err"></div>
    </section>

    <!-- Höger halva -->
    <section class="card">
      <h2 style="margin:0 0 10px">Händelser</h2>
      <div class="list" id="list"></div>
    </section>
  </div>

<script>
/* ====== KONFIG ====== */
const DEFAULT_API_BASE = 'https://script.google.com/macros/s/AKfycbySOXro_Qk9bqD98mUBbJ3h1voYuD-EJ1QD8ZLpsi3cw8feXCUx-shoMYI0umx6vEnW/exec';
const API_BASE = localStorage.getItem('apiUrl') || DEFAULT_API_BASE;

/* ====== Hjälpare ====== */
const uid = () => Math.random().toString(36).slice(2,10);
const el  = (sel) => document.querySelector(sel);
const MONTHS = ['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];

let ALL_EVENTS = [];
let VIEW_EVENTS = [];
let CATEGORY_COLORS = {};
let CATEGORY_LANES = {}; // kategori -> lane index

function hashStr(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return Math.abs(h); }
function colorForCategory(cat){ if(!cat) return 'var(--accent)'; if(CATEGORY_COLORS[cat]) return CATEGORY_COLORS[cat]; const h=hashStr(cat)%360; const clr=`hsl(${h} 70% 55%)`; CATEGORY_COLORS[cat]=clr; return clr; }

function showError(msg){ const box = el('#err'); box.textContent = msg; box.style.display = 'block'; }
function clearError(){ const box = el('#err'); box.textContent = ''; box.style.display = 'none'; }

/* ====== Tema ====== */
function initTheme(){
  const saved = localStorage.getItem('theme2') || 'dark';
  const root = document.documentElement;
  const sw = el('#themeSwitch');
  const lbl = el('#themeLabel');
  const isLight = saved==='light';
  root.classList.toggle('light', isLight);
  sw.checked = isLight;
  lbl.textContent = isLight ? 'Ljust läge' : 'Mörkt läge';
  sw.onchange = ()=>{
    const on = sw.checked;
    root.classList.toggle('light', on);
    localStorage.setItem('theme2', on ? 'light' : 'dark');
    lbl.textContent = on ? 'Ljust läge' : 'Mörkt läge';
  };
}

/* ====== Datum ====== */
function dayOfYear(date){ const start = new Date(Date.UTC(date.getUTCFullYear(),0,1)); return Math.floor((date - start) / 86400000)+1; }
function angleFor(date){
  const year = date.getUTCFullYear();
  const start = new Date(Date.UTC(year,0,1));
  const end   = new Date(Date.UTC(year+1,0,1));
  const totalDays = (end - start)/86400000;
  const day = dayOfYear(date);
  const frac = day / totalDays;
  return frac * Math.PI*2 - Math.PI/2;
}
function yearWindow(y){ return { start: new Date(Date.UTC(y,0,1)), end: new Date(Date.UTC(y,11,31,23,59,59)) }; }

/* ====== Hämta alla events ====== */
async function fetchEvents(){
  const base = localStorage.getItem('apiUrl') || API_BASE;
  const url = base + `?action=list`;
  const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
  if(!res.ok) throw new Error('API fel ('+res.status+')');
  const text = await res.text();
  try{ return JSON.parse(text); }catch(e){ throw new Error('API-svar var inte JSON'); }
}

/* ====== Filtrera till valt år + lanes ====== */
function filterForYear(all, y){
  const {start, end} = yearWindow(y);
  const arr = all.map(ev=>{
    const s = new Date(ev.start_date+'T12:00:00Z');
    const e = ev.end_date ? new Date(ev.end_date+'T23:59:59Z') : new Date(ev.start_date+'T23:59:59Z');
    if(e < start || s > end) return null;
    const segStart = new Date(Math.max(s, start));
    const segEnd   = new Date(Math.min(e, end));
    return {...ev, _segStart: segStart, _segEnd: segEnd};
  }).filter(Boolean);
  const cats = [...new Set(arr.map(e=>e.category||'Okategoriserat'))].sort();
  CATEGORY_LANES = Object.fromEntries(cats.map((c,i)=>[c,i]));
  return arr;
}

/* ====== Legend ====== */
function buildLegend(events){
  const wrap = el('#legend'); wrap.innerHTML='';
  const cats = new Map();
  events.forEach(e=>{
    const k = e.category || 'Okategoriserat';
    const col = e.color || colorForCategory(e.category);
    if(!cats.has(k)) cats.set(k, col);
  });
  for(const [cat,col] of cats.entries()){
    const chip=document.createElement('span');
    chip.className='chip';
    chip.innerHTML=`<span class="dot" style="background:${col}"></span>${cat}`;
    wrap.appendChild(chip);
  }
}

/* ====== Rita hjul (banor per kategori) ====== */
function drawWheel(events){
  const stage=el('#stage'); stage.innerHTML='';
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','-240 -240 480 480');

  const R=200, BASE_ARC=190, LANE_GAP=10;

  const ring=document.createElementNS(svg.namespaceURI,'circle');
  ring.setAttribute('r',R); ring.setAttribute('fill','none');
  ring.setAttribute('stroke','var(--border)'); ring.setAttribute('stroke-width','2');
  svg.appendChild(ring);

  for(let m=0;m<12;m++){
    const a=(m/12)*Math.PI*2 - Math.PI/2;
    const x1=Math.cos(a)*(R-20), y1=Math.sin(a)*(R-20);
    const x2=Math.cos(a)*R,      y2=Math.sin(a)*R;
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('stroke','var(--border)');
    svg.appendChild(line);

    const lbl=document.createElementNS(svg.namespaceURI,'text');
    lbl.setAttribute('x',Math.cos(a)*(R-45));
    lbl.setAttribute('y',Math.sin(a)*(R-45));
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('fill','var(--muted)');
    lbl.textContent=MONTHS[m];
    svg.appendChild(lbl);
  }

  const tip = el('#tooltip');
  function showTip(evt, html){ tip.innerHTML=html; tip.style.display='block'; const pad=12; tip.style.left=(evt.clientX+pad)+'px'; tip.style.top=(evt.clientY+pad)+'px'; tip.setAttribute('aria-hidden','false'); }
  function hideTip(){ tip.style.display='none'; tip.setAttribute('aria-hidden','true'); }

  function arcBetween(s,e,r,color,tipHtml,id){
    if(e.getTime() === s.getTime()){
      const a=angleFor(s);
      const dot=document.createElementNS(svg.namespaceURI,'circle');
      dot.setAttribute('cx',Math.cos(a)*r);
      dot.setAttribute('cy',Math.sin(a)*r);
      dot.setAttribute('r',6);
      dot.setAttribute('fill',color);
      dot.addEventListener('mouseenter',ev=>showTip(ev,tipHtml));
      dot.addEventListener('mousemove',ev=>showTip(ev,tipHtml));
      dot.addEventListener('mouseleave',hideTip);
      dot.style.cursor='pointer';
      dot.addEventListener('click',()=>{ const target=document.getElementById('item-'+(id||'')); if(target){ target.scrollIntoView({behavior:'smooth',block:'center'});} });
      svg.appendChild(dot);
      return;
    }
    const a1=angleFor(s), a2=angleFor(e);
    const delta=(a2-a1+Math.PI*2)%(Math.PI*2);
    const largeArc=delta>Math.PI?1:0;
    const x1=Math.cos(a1)*r, y1=Math.sin(a1)*r;
    const x2=Math.cos(a2)*r, y2=Math.sin(a2)*r;
    const path=document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d',`M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`);
    path.setAttribute('stroke',color); path.setAttribute('fill','none');
    path.setAttribute('stroke-width','6'); path.setAttribute('stroke-linecap','round'); path.setAttribute('opacity','0.9');
    path.addEventListener('mouseenter',ev=>showTip(ev,tipHtml));
    path.addEventListener('mousemove',ev=>showTip(ev,tipHtml));
    path.addEventListener('mouseleave',hideTip);
    path.style.cursor='pointer';
    path.addEventListener('click',()=>{ const target=document.getElementById('item-'+(id||'')); if(target){ target.scrollIntoView({behavior:'smooth',block:'center'});} });
    svg.appendChild(path);
  }

  events.forEach(ev=>{
    const lane = CATEGORY_LANES[ev.category || 'Okategoriserat'] || 0;
    const radius = BASE_ARC - lane*LANE_GAP;
    const color = ev.color || colorForCategory(ev.category);
    const s = ev._segStart; const e = ev._segEnd;
    const tipHtml = `<strong>${ev.title||''}</strong><br>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}`;
    arcBetween(s,e,radius,color,tipHtml,ev.id);
  });

  stage.appendChild(svg);
}

/* ====== Filterlogik ====== */
function getFiltered(base = VIEW_EVENTS){
  const q = el('#search').value.toLowerCase();
  const c = el('#category').value;
  return base.filter(ev=>{
    const hay = `${ev.title} ${ev.description||''} ${ev.category||''}`.toLowerCase();
    const okQ = !q || hay.includes(q);
    const okC = !c || ev.category === c;
    return okQ && okC;
  });
}
function updateFilteredUI(){
  const filtered = getFiltered(VIEW_EVENTS);
  buildLegend(filtered);
  drawWheel(filtered);
  renderList(VIEW_EVENTS);
}

/* ====== Lista ====== */
function renderList(events){
  const q = el('#search').value.toLowerCase();
  const c = el('#category').value;
  const list = el('#list'); list.innerHTML='';

  const filtered = events.filter(ev=>{
    const hay = `${ev.title} ${ev.description||''} ${ev.category||''}`.toLowerCase();
    return (!q || hay.includes(q)) && (!c || ev.category===c);
  }).sort((a,b)=> a.start_date.localeCompare(b.start_date));

  filtered.forEach(ev=>{
    const color = ev.color || colorForCategory(ev.category);
    const div = document.createElement('div');
    div.className='item'; div.id='item-'+(ev.id||'');
    div.innerHTML = `
      <h3><span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:999px;margin-right:8px"></span>${ev.title}</h3>
      <small>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}${ev.location?` • ${ev.location}`:''}</small>
      <div class="sp"></div>
      <p style="margin:0 0 8px">${ev.description||''}</p>
      ${ev.link?`<a href="${ev.link}" target="_blank" rel="noreferrer">Öppna länk</a>`:''}
    `;
    list.appendChild(div);
  });

  // Kategori-options från VY-data
  const catSel = el('#category');
  const current = catSel.value;
  const cats = [...new Set(events.map(e=>e.category).filter(Boolean))].sort();
  catSel.innerHTML = '<option value="">Alla kategorier</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if([...catSel.options].some(o=>o.value===current)) catSel.value = current;
}

/* ====== Init/Load ====== */
async function loadAll(){
  clearError();
  ALL_EVENTS = await fetchEvents();
  recomputeView();
}
function recomputeView(){
  try{
    clearError();
    const y = parseInt(el('#year').value || String(new Date().getFullYear()), 10);
    CATEGORY_COLORS = {};
    VIEW_EVENTS = filterForYear(ALL_EVENTS, y);
    updateFilteredUI();
  }catch(err){ showError(err.message); console.error(err); }
}
function populateYears(){
  const yearSel = el('#year');
  const y=new Date().getFullYear();
  const years=[y-1,y,y+1,y+2];
  yearSel.innerHTML=years.map(v=>`<option ${v===y?'selected':''} value="${v}">${v}</option>`).join('');
}

/* ====== Start ====== */
window.addEventListener('DOMContentLoaded',()=>{
  initTheme();
  populateYears();

  el('#refresh').onclick = ()=> loadAll();
  el('#category').onchange = ()=> updateFilteredUI();
  el('#search').oninput = ()=> updateFilteredUI();
  el('#year').onchange = ()=> recomputeView();

  loadAll();
});
</script>
</body>
</html>
