<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Årshjul</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --muted:#9fb0d3; --card:#101a33; --border:#1e2b4f;
      --accent:#72a3ff; --accent2:#ffcf70; --good:#5bd6a2; --bad:#ff7a7a;
    }
    :root.light{
      --bg:#ffffff; --fg:#0b1220; --muted:#52607a; --card:#ffffff; --border:#e5e7eb;
      --accent:#2b59ff; --accent2:#b45309; --good:#059669; --bad:#dc2626;
    }

    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg); transition:background .2s ease,color .2s ease}
    header{display:flex; gap:12px; align-items:center; padding:18px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,rgba(127,127,127,0.06),transparent)}
    h1{font-size:clamp(20px,2.6vw,28px); margin:0; letter-spacing:.3px}
    .wrap{display:grid; grid-template-columns:360px 1fr; gap:18px; padding:18px}
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; transition:background .2s ease,border-color .2s ease}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input, select, button, textarea{background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    button{cursor:pointer}
    .pill{display:inline-flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card)}

    .stage{display:grid; place-items:center; min-height:520px;}
    svg{max-width:100%; height:auto}

    .list{display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto;}
    .item{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px}
    .item h3{margin:0 0 6px; font-size:15px}
    .item small{color:var(--muted)}

    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .legend-item{display:flex; align-items:center; gap:6px; font-size:13px}
    .legend-color{width:12px; height:12px; border-radius:3px;}

    .admin{display:none;}
    .admin.show{display:block}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .mt{margin-top:12px}
    .right{margin-left:auto}
    .hint{color:var(--muted); font-size:12px}
    a{color:var(--accent)}
    .error{background:#2a0f14; border:1px solid #5a1b25; color:#ffd2d2; padding:10px; border-radius:10px; margin-top:10px; display:none}
    .tooltip{position:absolute; background:var(--card); color:var(--fg); border:1px solid var(--border); padding:6px 8px; border-radius:6px; font-size:12px; pointer-events:none; opacity:0; transition:opacity .15s ease}
  </style>
</head>
<body>
  <header>
    <h1>Årshjul</h1>
    <span class="pill">Datakälla: Google Sheet</span>
    <span class="pill">TZ: Europe/Stockholm</span>
    <div class="right"></div>
    <label class="pill" style="gap:6px; cursor:pointer">
      <input id="themeSwitch" type="checkbox" />
      <span id="themeLabel">Mörkt läge</span>
    </label>
    <button id="toggle-admin" style="margin-left:8px">Admin</button>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="row">
        <input id="search" placeholder="Sök titel/beskrivning…" />
        <select id="category"><option value="">Alla kategorier</option></select>
        <select id="year"></select>
        <button id="refresh">Uppdatera</button>
      </div>
      <div class="stage" id="stage"></div>
      <div class="legend" id="legend"></div>
      <div class="legend" id="legend"></div>
      <div class="error" id="err"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px">Händelser</h2>
      <div class="list" id="list"></div>
    </section>
  </div>

  <section class="card admin" id="admin">
    <h2>Adminpanel</h2>
    <div class="hint">Fyll i API-nyckel (ADMIN_TOKEN). URL är redan satt.</div>
    <div class="grid2 mt">
      <input id="apiUrl" />
      <input id="apiKey" placeholder="ADMIN_TOKEN" />
    </div>

    <h3>Lägg till / uppdatera händelse</h3>
    <div class="grid3">
      <input id="evId" placeholder="id (tomt = nytt)" />
      <input id="title" placeholder="Titel" />
      <input id="categoryInput" placeholder="Kategori" />
    </div>
    <div class="grid3 mt">
      <input id="start" type="date" />
      <input id="end" type="date" />
      <input id="color" type="color" value="#72a3ff" />
    </div>
    <div class="grid2 mt">
      <input id="link" placeholder="Länk (valfritt)" />
      <input id="location" placeholder="Plats (valfritt)" />
    </div>
    <textarea id="desc" class="mt" rows="3" placeholder="Beskrivning"></textarea>
    <div class="row mt">
      <button id="save">Spara</button>
      <button id="del">Ta bort</button>
    </div>
  </section>

  <div id="tooltip" class="tooltip"></div>

<script>
const DEFAULT_API_BASE = 'https://script.google.com/macros/s/AKfycbySOXro_Qk9bqD98mUBbJ3h1voYuD-EJ1QD8ZLpsi3cw8feXCUx-shoMYI0umx6vEnW/exec';
const API_BASE = localStorage.getItem('apiUrl') || DEFAULT_API_BASE;

const el = (sel)=>document.querySelector(sel);
const MONTHS = ['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
const tooltip = el('#tooltip');

function showError(msg){ el('#err').textContent=msg; el('#err').style.display='block'; }
function clearError(){ el('#err').style.display='none'; }

// ===== Tema =====
function initTheme(){
  const saved = localStorage.getItem('theme2')||'dark';
  const isLight = saved==='light';
  document.documentElement.classList.toggle('light', isLight);
  el('#themeSwitch').checked=isLight;
  el('#themeLabel').textContent=isLight?'Ljust läge':'Mörkt läge';
  el('#themeSwitch').onchange=()=>{
    const on=el('#themeSwitch').checked;
    document.documentElement.classList.toggle('light',on);
    localStorage.setItem('theme2', on?'light':'dark');
    el('#themeLabel').textContent=on?'Ljust läge':'Mörkt läge';
  };
}

async function fetchEvents(year){
  const url = API_BASE+`?action=list${year?`&year=${year}`:''}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('API-fel '+res.status);
  return res.json();
}

function angleFor(date){
  const year=date.getUTCFullYear();
  const start=new Date(Date.UTC(year,0,1));
  const end=new Date(Date.UTC(year+1,0,1));
  const total=(end-start)/86400000;
  const day=Math.floor((date-start)/86400000)+1;
  return (day/total)*Math.PI*2-Math.PI/2;
}

function drawWheel(events){
  const stage=el('#stage'); stage.innerHTML='';
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','-240 -240 480 480');

  const ring=document.createElementNS(svg.namespaceURI,'circle');
  ring.setAttribute('r','200'); ring.setAttribute('fill','none');
  ring.setAttribute('stroke','var(--border)'); ring.setAttribute('stroke-width','2');
  svg.appendChild(ring);

  for(let m=0;m<12;m++){
    const a=(m/12)*Math.PI*2-Math.PI/2;
    const x1=Math.cos(a)*180,y1=Math.sin(a)*180;
    const x2=Math.cos(a)*200,y2=Math.sin(a)*200;
    const line=document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2);
    line.setAttribute('stroke','var(--border)');
    svg.appendChild(line);

    const lbl=document.createElementNS(svg.namespaceURI,'text');
    lbl.setAttribute('x',Math.cos(a)*155); lbl.setAttribute('y',Math.sin(a)*155);
    lbl.setAttribute('text-anchor','middle');
    lbl.setAttribute('fill','var(--muted)');
    lbl.textContent=MONTHS[m];
    svg.appendChild(lbl);
  }

  function arcBetween(s,e,color,ev){
    const a1=angleFor(s),a2=angleFor(e);
    const delta=(a2-a1+Math.PI*2)%(Math.PI*2);
    const largeArc=delta>Math.PI?1:0;
    const x1=Math.cos(a1)*190,y1=Math.sin(a1)*190;
    const x2=Math.cos(a2)*190,y2=Math.sin(a2)*190;
    const path=document.createElementNS(svg.namespaceURI,'path');
    path.setAttribute('d',`M ${x1} ${y1} A 190 190 0 ${largeArc} 1 ${x2} ${y2}`);
    path.setAttribute('stroke',color); path.setAttribute('fill','none');
    path.setAttribute('stroke-width','6'); path.setAttribute('stroke-linecap','round');
    path.addEventListener('mousemove',(e)=>showTooltip(e,ev));
    path.addEventListener('mouseleave',hideTooltip);
    svg.appendChild(path);
  }

  events.forEach(ev=>{
    const color=ev.color||'var(--accent)';
    const sd=new Date(ev.start_date+'T12:00:00Z');
    const ed=ev.end_date?new Date(ev.end_date+'T12:00:00Z'):null;
    if(ed) arcBetween(sd,ed,color,ev); else {
      const a=angleFor(sd);
      const dot=document.createElementNS(svg.namespaceURI,'circle');
      dot.setAttribute('cx',Math.cos(a)*190); dot.setAttribute('cy',Math.sin(a)*190);
      dot.setAttribute('r','6'); dot.setAttribute('fill',color);
      dot.addEventListener('mousemove',(e)=>showTooltip(e,ev));
      dot.addEventListener('mouseleave',hideTooltip);
      svg.appendChild(dot);
    }
  });

  stage.appendChild(svg);
  renderLegend(events);
}

function renderLegend(events){
  const legend=el('#legend'); legend.innerHTML='';
  const cats=[...new Map(events.filter(e=>e.category).map(e=>[e.category,e.color||'var(--accent)'])).entries()];
  cats.forEach(([cat,color])=>{
    const div=document.createElement('div'); div.className='legend-item';
    div.innerHTML=`<span class="legend-color" style="background:${color}"></span>${cat}`;
    legend.appendChild(div);
  });
}

function showTooltip(evt,ev){
  tooltip.innerHTML=`<strong>${ev.title}</strong><br>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}`;
  tooltip.style.left=(evt.pageX+10)+'px';
  tooltip.style.top=(evt.pageY+10)+'px';
  tooltip.style.opacity=1;
}
function hideTooltip(){ tooltip.style.opacity=0; }

function renderList(events){
  const q=el('#search').value.toLowerCase();
  const c=el('#category').value;
  const list=el('#list'); list.innerHTML='';
  events.filter(ev=>(!q||ev.title.toLowerCase().includes(q))&&(!c||ev.category===c))
    .sort((a,b)=>a.start_date.localeCompare(b.start_date))
    .forEach(ev=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`<h3>${ev.title}</h3><small>${ev.start_date}${ev.end_date?` – ${ev.end_date}`:''}${ev.category?` • ${ev.category}`:''}</small><p>${ev.description||''}</p>`;
      list.appendChild(div);
    });
}

async function load(y){ try{clearError(); const d=await fetchEvents(y); drawWheel(d); renderList(d);}catch(e){showError(e.message);} }
function populateYears(){ const y=new Date().getFullYear(); el('#year').innerHTML=[y-1,y,y+1].map(v=>`<option ${v===y?'selected':''}>${v}</option>`).join(''); }

async function adminPost(action,payload){
  const base=el('#apiUrl').value.trim();
  const key=el('#apiKey').value.trim();
  if(!base||!key){alert('Fyll i API-URL + nyckel');return;}
  localStorage.setItem('apiUrl',base); localStorage.setItem('apiKey',key);
  const body=new URLSearchParams({action,token:key,...payload});
  const res=await fetch(base,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
  const j=await res.json(); if(j.error){alert('Fel: '+j.error);return;}
  await load(el('#year').value); alert('Klart!');
}

window.addEventListener('DOMContentLoaded',()=>{
  initTheme(); populateYears();
  el('#apiUrl').value=API_BASE; el('#apiKey').value=localStorage.getItem('apiKey')||'';
  el('#refresh').onclick=()=>load(el('#year').value);
  el('#toggle-admin').onclick=()=>el('#admin').classList.toggle('show');
  el('#save').onclick=()=>{
    if(!el('#title').value||!el('#start').value){alert('Titel och startdatum krävs');return;}
    adminPost('upsert',{
      id:(el('#evId').value||'').trim()||Math.random().toString(36).slice(2,10),
      title:el('#title').value.trim(), description:el('#desc').value.trim(),
      start_date:el('#start').value, end_date:el('#end').value||'',
      category:el('#categoryInput').value.trim()||'', color:el('#color').value||'',
      link:el('#link').value.trim()||'', location:el('#location').value.trim()||''
